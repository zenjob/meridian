name: Check URL Reachability

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to check reachability for'
        required: false
        default: ''
        type: string
      timeout:
        description: 'Timeout in seconds for the request'
        required: false
        default: '30'
        type: string

jobs:
  check-reachability:
    runs-on: preprod-xs-runner
    timeout-minutes: 10

    steps:
      - name: Check URL Reachability
        run: |
          URL="${{ github.event.inputs.url }}"
          TIMEOUT="${{ github.event.inputs.timeout || '30' }}"

          echo "🔍 Checking reachability for: $URL"
          echo "⏱️ Timeout set to: ${TIMEOUT}s"
          echo "🏃 Running from: $(curl -s https://ipinfo.io/ip 2>/dev/null || echo 'unknown')"
          echo "📍 Runner location: $(curl -s https://ipinfo.io/city 2>/dev/null || echo 'unknown'), $(curl -s https://ipinfo.io/country 2>/dev/null || echo 'unknown')"
          echo ""

          # Test basic connectivity with curl
          echo "🌐 Testing HTTP connectivity..."
          if curl -sSf --max-time "$TIMEOUT" --connect-timeout 10 -o /dev/null -w "HTTP Status: %{http_code}\nTotal Time: %{time_total}s\nName Lookup: %{time_namelookup}s\nConnect Time: %{time_connect}s\nRedirect Time: %{time_redirect}s\n" "$URL"; then
            echo "✅ SUCCESS: URL is reachable!"
          else
            echo "❌ FAILURE: URL is not reachable!"
            exit_code=$?
            echo "Exit code: $exit_code"
          fi

          echo ""

          # Test with verbose output for debugging
          echo "🔧 Detailed connectivity test..."
          curl -v --max-time "$TIMEOUT" --connect-timeout 10 "$URL" 2>&1 | head -20

          echo ""

          # Test DNS resolution
          echo "🔍 DNS Resolution test..."
          nslookup $(echo "$URL" | sed 's|https\?://||' | sed 's|/.*||') || echo "DNS resolution failed"

          echo ""

          # Test ping if possible (may not work in all environments)
          echo "📡 Network connectivity test..."
          HOST=$(echo "$URL" | sed 's|https\?://||' | sed 's|/.*||')
          ping -c 3 "$HOST" 2>/dev/null || echo "Ping test unavailable or failed"

      - name: Summary
        if: always()
        run: |
          echo "📋 Reachability check completed for: ${{ github.event.inputs.url }}"
          echo "🕐 Check performed at: $(date -u)"
          echo "🏃 Runner: ${{ runner.os }} on ${{ runner.arch }}"
